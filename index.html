<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Streaming Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center font-sans p-4">

    <div class="w-full max-w-md mx-auto">
        <!-- View Toggles -->
        <div class="flex justify-center mb-6 bg-gray-800 rounded-full p-1">
            <button id="server-view-btn"
                class="w-full text-center py-2 px-4 rounded-full transition-all duration-300 bg-indigo-600 shadow-lg">
                <div class="flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="mr-2">
                        <rect width="20" height="8" x="2" y="2" rx="2" ry="2" />
                        <rect width="20" height="8" x="2" y="14" rx="2" ry="2" />
                        <line x1="6" x2="6.01" y1="6" y2="6" />
                        <line x1="6" x2="6.01" y1="18" y2="18" />
                    </svg>
                    <span>Server</span>
                </div>
            </button>
            <button id="client-view-btn"
                class="w-full text-center py-2 px-4 rounded-full transition-all duration-300 hover:bg-gray-700">
                <div class="flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="mr-2">
                        <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" />
                        <circle cx="12" cy="7" r="4" />
                    </svg>
                    <span>Client</span>
                </div>
            </button>
        </div>

        <!-- Server Interface -->
        <div id="server-interface">
            <div class="bg-gray-800 rounded-2xl p-6 shadow-2xl border border-gray-700">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-indigo-400">Server Control</h2>
                    <div class="w-3 h-3 rounded-full bg-indigo-500 animate-pulse"></div>
                </div>
                <div class="bg-gray-900 rounded-lg p-4 mb-6">
                    <p class="text-sm text-gray-400 mb-2">Status:</p>
                    <div id="server-status-indicator" class="text-lg font-medium flex items-center text-gray-400"></div>
                </div>
                <div id="server-transmitting-indicator" class="flex items-center justify-center h-16 mb-6 hidden"></div>
                <div id="server-buttons" class="flex flex-col space-y-4">
                    <button id="start-server-btn"
                        class="w-full flex items-center justify-center bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 shadow-lg hover:shadow-indigo-500/50"></button>
                    <button id="stop-server-btn"
                        class="w-full flex items-center justify-center bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 shadow-lg hover:shadow-red-500/50 hidden"></button>
                </div>
            </div>
        </div>

        <!-- Client Interface -->
        <div id="client-interface" class="hidden">
            <div class="bg-gray-800 rounded-2xl p-6 shadow-2xl border border-gray-700">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-green-400">Client Control</h2>
                    <div class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></div>
                </div>
                <div class="bg-gray-900 rounded-lg p-4 mb-6">
                    <p class="text-sm text-gray-400 mb-2">Status:</p>
                    <div id="client-status-indicator" class="text-lg font-medium flex items-center text-gray-400"></div>
                </div>
                <div class="mb-6">
                    <label for="server-ip" class="block text-sm text-gray-400 mb-2">Server IP Address:</label>
                    <input type="text" id="server-ip" placeholder="e.g., 192.168.1.10"
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-green-500 font-mono">
                </div>
                <div id="client-transmitting-indicator" class="flex items-center justify-center h-16 mb-6 hidden"></div>
                <div id="client-buttons" class="flex flex-col space-y-4">
                    <button id="connect-btn"
                        class="w-full flex items-center justify-center bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 shadow-lg hover:shadow-green-500/50"></button>
                    <button id="disconnect-btn"
                        class="w-full flex items-center justify-center bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 shadow-lg hover:shadow-red-500/50 hidden"></button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Global State & Web Audio/WebSocket Variables ---
            let websocket;
            let audioContext;
            let audioSource;
            let processor;
            let isStreaming = false;
            const CHUNK_SIZE = 1024;
            const SAMPLE_RATE = 44100;

            // --- DOM Elements ---
            const serverViewBtn = document.getElementById('server-view-btn');
            const clientViewBtn = document.getElementById('client-view-btn');
            const serverInterface = document.getElementById('server-interface');
            const clientInterface = document.getElementById('client-interface');

            // Server elements
            const serverStatusIndicator = document.getElementById('server-status-indicator');
            const serverTransmittingIndicator = document.getElementById('server-transmitting-indicator');
            const startServerBtn = document.getElementById('start-server-btn');
            const stopServerBtn = document.getElementById('stop-server-btn');

            // Client elements
            const clientStatusIndicator = document.getElementById('client-status-indicator');
            const clientTransmittingIndicator = document.getElementById('client-transmitting-indicator');
            const serverIpInput = document.getElementById('server-ip');
            const connectBtn = document.getElementById('connect-btn');
            const disconnectBtn = document.getElementById('disconnect-btn');

            // --- Icons and UI Templates ---
            const icons = {
                power: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"/><line x1="12" x2="12" y1="2" y2="12"/></svg>`,
                off: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>`,
                listening: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 animate-pulse"><path d="M4.9 19.1C1 15.2 1 8.8 4.9 4.9"/><path d="M7.8 16.2c-2.3-2.3-2.3-6.1 0-8.5"/><circle cx="12" cy="12" r="2"/><path d="M16.2 7.8c2.3 2.3 2.3 6.1 0 8.5"/><path d="M19.1 4.9C23 8.8 23 15.2 19.1 19.1"/></svg>`,
                connected: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M13 2 3 14h9l-1 8 10-12h-9l1-8z"/></svg>`,
                mic: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-pulse"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>`
            };
            const transmittingIndicatorHTML = `<div class="flex items-center space-x-2 text-cyan-400">${icons.mic}<span class="font-semibold">Transmitting Audio...</span></div>`;

            // --- UI Update Functions ---
            function updateServerUI(status) {
                serverTransmittingIndicator.classList.add('hidden');
                switch (status) {
                    case 'Off':
                        serverStatusIndicator.innerHTML = `${icons.off}<span>Server is Off</span>`;
                        serverStatusIndicator.className = 'text-lg font-medium flex items-center text-gray-400';
                        startServerBtn.classList.remove('hidden');
                        stopServerBtn.classList.add('hidden');
                        break;
                    case 'Connecting':
                        serverStatusIndicator.innerHTML = `${icons.listening}<span>Connecting...</span>`;
                        serverStatusIndicator.className = 'text-lg font-medium flex items-center text-yellow-400';
                        startServerBtn.classList.add('hidden');
                        stopServerBtn.classList.remove('hidden');
                        break;
                    case 'Connected':
                        serverStatusIndicator.innerHTML = `${icons.connected}<span>Client Connected</span>`;
                        serverStatusIndicator.className = 'text-lg font-medium flex items-center text-green-400';
                        serverTransmittingIndicator.classList.remove('hidden');
                        startServerBtn.classList.add('hidden');
                        stopServerBtn.classList.remove('hidden');
                        break;
                }
            }

            function updateClientUI(status) {
                clientTransmittingIndicator.classList.add('hidden');
                serverIpInput.disabled = false;
                switch (status) {
                    case 'Disconnected':
                        clientStatusIndicator.innerHTML = `${icons.off}<span>Disconnected</span>`;
                        clientStatusIndicator.className = 'text-lg font-medium flex items-center text-gray-400';
                        connectBtn.classList.remove('hidden');
                        disconnectBtn.classList.add('hidden');
                        break;
                    case 'Connecting':
                        clientStatusIndicator.innerHTML = `${icons.listening}<span>Connecting...</span>`;
                        clientStatusIndicator.className = 'text-lg font-medium flex items-center text-yellow-400';
                        serverIpInput.disabled = true;
                        connectBtn.classList.add('hidden');
                        disconnectBtn.classList.remove('hidden');
                        break;
                    case 'Connected':
                        clientStatusIndicator.innerHTML = `${icons.connected}<span>Connected to Server</span>`;
                        clientStatusIndicator.className = 'text-lg font-medium flex items-center text-green-400';
                        clientTransmittingIndicator.classList.remove('hidden');
                        serverIpInput.disabled = true;
                        connectBtn.classList.add('hidden');
                        disconnectBtn.classList.remove('hidden');
                        break;
                }
            }

            function initializeUI() {
                startServerBtn.innerHTML = `${icons.power} Start Server`;
                stopServerBtn.innerHTML = `${icons.power} Stop Server`;
                connectBtn.innerHTML = `${icons.power} Connect`;
                disconnectBtn.innerHTML = `${icons.power} Disconnect`;
                serverTransmittingIndicator.innerHTML = transmittingIndicatorHTML;
                clientTransmittingIndicator.innerHTML = transmittingIndicatorHTML;
                updateServerUI('Off');
                updateClientUI('Disconnected');
            }

            // --- View Switching Logic ---
            serverViewBtn.addEventListener('click', () => {
                clientInterface.classList.add('hidden');
                serverInterface.classList.remove('hidden');
                clientViewBtn.className = 'w-full text-center py-2 px-4 rounded-full transition-all duration-300 hover:bg-gray-700';
                serverViewBtn.className = 'w-full text-center py-2 px-4 rounded-full transition-all duration-300 bg-indigo-600 shadow-lg';
            });

            clientViewBtn.addEventListener('click', () => {
                serverInterface.classList.add('hidden');
                clientInterface.classList.remove('hidden');
                serverViewBtn.className = 'w-full text-center py-2 px-4 rounded-full transition-all duration-300 hover:bg-gray-700';
                clientViewBtn.className = 'w-full text-center py-2 px-4 rounded-full transition-all duration-300 bg-green-600 shadow-lg';
            });

            // --- Core Web Audio and WebSocket Logic ---
            async function startStreaming(server_ws_url, uiUpdater) {
                if (isStreaming) return;

                uiUpdater('Connecting');

                websocket = new WebSocket(server_ws_url);

                websocket.onopen = async () => {
                    console.log("WebSocket connection established.");
                    uiUpdater('Connected');
                    isStreaming = true;

                    audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: SAMPLE_RATE });

                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        audioSource = audioContext.createMediaStreamSource(stream);
                        processor = audioContext.createScriptProcessor(CHUNK_SIZE, 1, 1);

                        processor.onaudioprocess = (e) => {
                            if (websocket.readyState !== WebSocket.OPEN) return;
                            const inputData = e.inputBuffer.getChannelData(0);
                            const pcmData = new Int16Array(inputData.length);
                            for (let i = 0; i < inputData.length; i++) {
                                let s = Math.max(-1, Math.min(1, inputData[i]));
                                pcmData[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                            }
                            websocket.send(pcmData.buffer);
                        };

                        websocket.onmessage = async (event) => {
                            if (!audioContext || audioContext.state === 'closed') return;
                            const receivedData = new Int16Array(await event.data.arrayBuffer());
                            const audioBuffer = audioContext.createBuffer(1, receivedData.length, SAMPLE_RATE);
                            const float32Data = new Float32Array(receivedData.length);
                            for (let i = 0; i < receivedData.length; i++) {
                                float32Data[i] = receivedData[i] / 32768.0;
                            }
                            audioBuffer.copyToChannel(float32Data, 0);

                            const bufferSource = audioContext.createBufferSource();
                            bufferSource.buffer = audioBuffer;
                            bufferSource.connect(audioContext.destination);
                            bufferSource.start();
                        };

                        audioSource.connect(processor);
                        processor.connect(audioContext.destination);

                    } catch (e) {
                        console.error("Error setting up audio:", e);
                        alert("Could not get microphone access. Please check permissions.");
                        stopStreaming();
                    }
                };

                websocket.onclose = () => {
                    console.log("WebSocket connection closed.");
                    stopStreaming();
                };

                websocket.onerror = (error) => {
                    console.error("WebSocket error:", error);
                    alert("Connection failed. Is the server running?");
                    stopStreaming();
                };
            }

            function stopStreaming() {
                // *** THE FIX IS HERE ***
                // This guard clause prevents the function from running if it's already stopped.
                if (!isStreaming) {
                    return;
                }
                isStreaming = false; // Set state to stopped immediately

                if (processor) processor.disconnect();
                if (audioSource) audioSource.disconnect();
                // Check if context exists and is not already closed before trying to close it.
                if (audioContext && audioContext.state !== 'closed') {
                    audioContext.close();
                }
                if (websocket) {
                    // We only need to close it if it's not already closing or closed.
                    if (websocket.readyState === WebSocket.OPEN || websocket.readyState === WebSocket.CONNECTING) {
                        websocket.close();
                    }
                }

                // Reset UI for both views
                updateServerUI('Off');
                updateClientUI('Disconnected');
            }

            // --- Button Event Listeners ---
            startServerBtn.addEventListener('click', () => startStreaming('ws://localhost:8765', updateServerUI));
            stopServerBtn.addEventListener('click', stopStreaming);
            connectBtn.addEventListener('click', () => {
                const ip = serverIpInput.value.trim();
                if (!ip) {
                    alert("Please enter the server's IP address.");
                    return;
                }
                startStreaming(`ws://${ip}:8765`, updateClientUI);
            });
            disconnectBtn.addEventListener('click', stopStreaming);

            // --- Initial UI Setup ---
            initializeUI();
        });
    </script>
</body>

</html>